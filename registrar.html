<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registrar Expediente - ICAP Nacional</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background-color: #fafafa;
      font-family: 'Inter', sans-serif;
      color: #2d2d2d;
      padding: 20px;
      line-height: 1.5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      padding: 32px;
    }
    .logo {
      width: 80px;
      display: block;
      margin: 0 auto 20px;
    }
    h1 {
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      color: #2d2d2d;
      margin-bottom: 16px;
    }
    .btn-config-lists {
      background-color: #722F37;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 16px;
      display: block;
      width: fit-content;
      margin-left: auto;
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #722F37;
      margin: 28px 0 16px;
      padding-bottom: 6px;
      border-bottom: 2px solid #f0f0f0;
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      margin-bottom: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #333;
    }
    input, select, textarea {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 15px;
      background-color: #fdfdfd;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #722F37;
      box-shadow: 0 0 0 3px rgba(114, 47, 55, 0.1);
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* Estilo para la foto */
    .photo-upload-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 24px;
    }
    .photo-preview-box {
      width: 120px;
      height: 120px;
      border: 2px dashed #ccc;
      border-radius: 10px;
      background-color: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      overflow: hidden;
    }
    .photo-preview-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .photo-placeholder {
      color: #999;
      font-size: 28px;
    }
    .photo-input {
      width: 100%;
      max-width: 220px;
      padding: 8px;
      font-size: 14px;
      text-align: center;
    }

    .btn-save {
      background-color: #722F37;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s ease;
      display: block;
      width: 100%;
      max-width: 220px;
    }
    .btn-save:hover {
      background-color: #5e262d;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(114, 47, 55, 0.2);
    }
    .back-link {
      display: inline-block;
      margin-top: 10px;
      color: #722F37;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
    }
    .back-link:hover {
      text-decoration: underline;
    }

    /* Modal de gesti√≥n */
    #configModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow: auto;
    }
    .config-content {
      background: white;
      margin: 40px auto;
      padding: 24px;
      width: 90%;
      max-width: 700px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      max-height: 80vh;
      overflow-y: auto;
    }
    .config-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid #eee;
    }
    .config-header h2 {
      color: #722F37;
      font-size: 20px;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #777;
    }
    .config-section {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px dashed #f0f0f0;
    }
    .config-section:last-child {
      border-bottom: none;
    }
    .config-section h3 {
      margin-bottom: 12px;
      font-size: 16px;
      color: #333;
      font-weight: 600;
    }
    .option-list {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 12px;
      min-height: 50px;
      background: #fcfcfc;
    }
    .option-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 14px;
      align-items: center;
    }
    .add-option {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .add-option input {
      flex: 1;
      padding: 8px 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    .add-option button {
      padding: 8px 14px;
      background: #722F37;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .add-option button:hover {
      background: #5e262d;
    }
  </style>
</head>
<body>
  <div class="container">
    <img 
      src="https://raw.githubusercontent.com/icapnacional/sistema-expedientes/main/Logo.png" 
      alt="ICAP Nacional - PNB" 
      class="logo"
    />
    <h1>Registrar Nuevo Expediente</h1>

    <!-- ‚úÖ BOT√ìN DE GESTI√ìN DE LISTAS -->
    <button class="btn-config-lists" onclick="openConfigModal()">‚öôÔ∏è Gestionar Listas</button>

    <!-- ‚úÖ CUADRO DE FOTO CENTRADO -->
    <div class="photo-upload-container">
      <div class="photo-preview-box" id="photoPreview">
        <span class="photo-placeholder">üì∑</span>
      </div>
      <input type="file" id="fotoInput" accept="image/*" class="photo-input">
    </div>

    <!-- Secci√≥n: Datos Personales -->
    <h2 class="section-title">Datos Personales</h2>
    <div class="form-row">
      <div class="form-group">
        <label for="nombre">Nombre</label>
        <input type="text" id="nombre" required>
      </div>
      <div class="form-group">
        <label for="apellido">Apellido</label>
        <input type="text" id="apellido" required>
      </div>
      <div class="form-group">
        <label for="fechaNac">Fecha de Nacimiento</label>
        <input type="date" id="fechaNac">
      </div>
      <div class="form-group">
        <label for="cedula">C√©dula de Identidad</label>
        <input type="text" id="cedula" placeholder="V-12345678">
      </div>
      <div class="form-group">
        <label for="sexo">Sexo</label>
        <select id="sexo">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="edad">Edad</label>
        <input type="number" id="edad" min="18" max="100">
      </div>
      <div class="form-group">
        <label for="jerarquia">Jerarqu√≠a</label>
        <select id="jerarquia">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="estatusPersonal">Estatus</label>
        <select id="estatusPersonal">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="telefono">Tel√©fono</label>
        <input type="tel" id="telefono" placeholder="0412-1234567">
      </div>
      <div class="form-group">
        <label for="correo">Correo</label>
        <input type="email" id="correo">
      </div>
      <div class="form-group">
        <label for="direccion">Direcci√≥n</label>
        <textarea id="direccion" placeholder="Direcci√≥n completa"></textarea>
      </div>
    </div>

    <!-- Secci√≥n: Expediente -->
    <h2 class="section-title">Expediente</h2>
    <div class="form-row">
      <div class="form-group">
        <label for="tipoExpediente">Tipo de Expediente</label>
        <select id="tipoExpediente">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="icapOficina">ICAP (Oficina)</label>
        <select id="icapOficina">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="funcInvestigado">Funcionario Investigado</label>
        <select id="funcInvestigado">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="condicionFunc">Condici√≥n del Funcionario en el Caso</label>
        <select id="condicionFunc">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="denunciante">Denunciante</label>
        <select id="denunciante">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="origenFalta">Origen de la Falta</label>
        <select id="origenFalta">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="tipoFalta">Tipo de Falta</label>
        <select id="tipoFalta">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="faltaArt">Falta (Art√≠culo)</label>
        <select id="faltaArt">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="estatusExpediente">Estatus</label>
        <select id="estatusExpediente">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="decision">Decisi√≥n</label>
        <select id="decision">
          <option value="">Cargando...</option>
        </select>
      </div>
    </div>

    <!-- Campos de texto libre -->
    <div class="form-group">
      <label for="resena">Rese√±a del Caso</label>
      <textarea id="resena" placeholder="Descripci√≥n detallada del caso..."></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="servicioLabora">Servicio donde Labora</label>
        <input type="text" id="servicioLabora">
      </div>
      <div class="form-group">
        <label for="expedientePenalAnio">Expediente Penal A√±o</label>
        <input type="number" id="expedientePenalAnio" min="1900" max="2099">
      </div>
      <div class="form-group">
        <label for="fechaInicio">Fecha de Inicio</label>
        <input type="date" id="fechaInicio">
      </div>
      <div class="form-group">
        <label for="expedienteNumero">Expediente N√∫mero</label>
        <input type="text" id="expedienteNumero" placeholder="Ej: EXP-2024-1234">
      </div>
      <div class="form-group">
        <label for="causa">Causa</label>
        <input type="text" id="causa">
      </div>
      <div class="form-group">
        <label for="funcDetenido">¬øFuncionario Detenido?</label>
        <select id="funcDetenido">
          <option value="">Cargando...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="sustanciador">Sustanciador Remisi√≥n</label>
        <input type="text" id="sustanciador">
      </div>
      <div class="form-group">
        <label for="registradoPor">Registrado Por</label>
        <input type="text" id="registradoPor">
      </div>
    </div>

    <button class="btn-save">Guardar Expediente</button>
    <a href="index.html" class="back-link">‚Üê Volver al Panel</a>
  </div>

  <!-- Modal de gesti√≥n -->
  <div id="configModal">
    <div class="config-content">
      <div class="config-header">
        <h2>Gestionar Listas</h2>
        <button class="close-btn" onclick="closeConfigModal()">√ó</button>
      </div>

      <!-- Listas de Datos Personales -->
      <div class="config-section">
        <h3>üßç Sexo</h3>
        <div class="option-list" id="sexoList"></div>
        <div class="add-option">
          <input type="text" id="newSexo" placeholder="Ej: No binario">
          <button onclick="addOption('sexos', 'newSexo', 'sexoList')">+</button>
        </div>
      </div>

      <div class="config-section">
        <h3>üéñÔ∏è Jerarqu√≠a</h3>
        <div class="option-list" id="jerarquiaList"></div>
        <div class="add-option">
          <input type="text" id="newJerarquia" placeholder="Ej: Comisario General">
          <button onclick="addOption('jerarquias', 'newJerarquia', 'jerarquiaList')">+</button>
        </div>
      </div>

      <div class="config-section">
        <h3>üßç Estatus (Datos Personales)</h3>
        <div class="option-list" id="estatusPersonalList"></div>
        <div class="add-option">
          <input type="text" id="newEstatusPersonal" placeholder="Ej: Jubilado">
          <button onclick="addOption('estatus_personales', 'newEstatusPersonal', 'estatusPersonalList')">+</button>
        </div>
      </div>

      <!-- Listas de Expediente -->
      <div class="config-section">
        <h3>üìÅ Tipo de Expediente</h3>
        <div class="option-list" id="tipoExpedienteList"></div>
        <div class="add-option">
          <input type="text" id="newTipoExpediente" placeholder="Ej: Disciplinario">
          <button onclick="addOption('tipos_expediente', 'newTipoExpediente', 'tipoExpedienteList')">+</button>
        </div>
      </div>

      <div class="config-section">
        <h3>üè¢ ICAP (Oficina)</h3>
        <div class="option-list" id="icapOficinaList"></div>
        <div class="add-option">
          <input type="text" id="newIcapOficina" placeholder="Ej: Caracas">
          <button onclick="addOption('icap_oficinas', 'newIcapOficina', 'icapOficinaList')">+</button>
        </div>
      </div>

      <div class="config-section">
        <h3>üëÆ Funcionario Investigado</h3>
        <div class="option-list" id="funcInvestigadoList"></div>
        <div class="add-option">
          <input type="text" id="newFuncInvestigado" placeholder="Ej: Capit√°n Juan P√©rez">
          <button onclick="addOption('func_investigados', 'newFuncInvestigado', 'funcInvestigadoList')">+</button>
        </div>
      </div>

      <div class="config-section">
        <h3>‚öñÔ∏è Condici√≥n del Funcionario</h3>
        <div class="option-list" id="condicionFuncList"></div>
        <div class="add-option">
          <input type="text" id="newCondicionFunc" placeholder="Ej: Imputado">
          <button onclick="addOption('condiciones_func', 'newCondicionFunc', 'condicionFuncList')">+</button>
        </div>
      </div>

      <div class="config-section">
        <h3>üì¢ Denunciante</h3>
        <div class="option-list" id="denuncianteList"></div>
        <div class="add-option">
          <input type="text" id="newDenunciante" placeholder="Ej: Ciudadano An√≥nimo">
          <button onclick="addOption('denunciantes', 'newDenunciante', 'denuncianteList')">+</button>
        </div>
      </div>

      <div class="config-section">
        <h3>üîç Origen de la Falta</h3>
        <div class="option-list" id="origenFaltaList"></div>
        <div class="add-option">
          <input type="text" id="newOrigenFalta" placeholder="Ej: Interna">
          <button onclick="addOption('origenes_falta', 'newOrigenFalta', 'origenFaltaList')">+</button>
        </div>
      </div>

      <div class="config-section">
        <h3>‚ö†Ô∏è Tipo de Falta</h3>
        <div class="option-list" id="tipoFaltaList"></div>
        <div class="add-option">
          <input type="text" id="newTipoFalta" placeholder="Ej: Leve">
          <button onclick="addOption('tipos_falta', 'newTipoFalta', 'tipoFaltaList')">+</button>
        </div>
      </div>

      <div class="config-section">
        <h3>üìú Falta (Art√≠culo)</h3>
        <div class="option-list" id="faltaArtList"></div>
        <div class="add-option">
          <input type="text" id="newFaltaArt" placeholder="Ej: Art. 49 ‚Äì Negligencia">
          <button onclick="addOption('faltas_art', 'newFaltaArt', 'faltaArtList')">+</button>
        </div>
      </div>

      <div class="config-section">
        <h3>üìä Estatus (Expediente)</h3>
        <div class="option-list" id="estatusExpedienteList"></div>
        <div class="add-option">
          <input type="text" id="newEstatusExpediente" placeholder="Ej: Archivado">
          <button onclick="addOption('estatus_expedientes', 'newEstatusExpediente', 'estatusExpedienteList')">+</button>
        </div>
      </div>

      <div class="config-section">
        <h3>‚úÖ Decisi√≥n</h3>
        <div class="option-list" id="decisionList"></div>
        <div class="add-option">
          <input type="text" id="newDecision" placeholder="Ej: Sanci√≥n Administrativa">
          <button onclick="addOption('decisiones', 'newDecision', 'decisionList')">+</button>
        </div>
      </div>

      <div class="config-section">
        <h3>üîí ¬øFuncionario Detenido?</h3>
        <div class="option-list" id="funcDetenidoList"></div>
        <div class="add-option">
          <input type="text" id="newFuncDetenido" placeholder="Ej: S√≠">
          <button onclick="addOption('func_detenidos', 'newFuncDetenido', 'funcDetenidoList')">+</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // üîë Supabase
    const SUPABASE_URL = 'https://stwriaubepeugobgyxjt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0d3JpYXViZXBldWdvYmd5eGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NDU0MDUsImV4cCI6MjA3MDMyMTQwNX0.3Rorn10j19M2nmmv03oSEwm-O-y0bsywAA8_CRR2O1g';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Listas por defecto
    const defaultLists = {
      sexos: [{label:'Masculino',value:'masculino'},{label:'Femenino',value:'femenino'},{label:'Otro',value:'otro'}],
      jerarquias: [
        {label:'Comisario General',value:'comisario_general'},
        {label:'Comisario Jefe',value:'comisario_jefe'},
        {label:'Comisario',value:'comisario'},
        {label:'Subcomisario',value:'subcomisario'},
        {label:'Inspector Jefe',value:'inspector_jefe'},
        {label:'Inspector',value:'inspector'},
        {label:'Subinspector',value:'subinspector'},
        {label:'Oficial Jefe',value:'oficial_jefe'},
        {label:'Oficial',value:'oficial'},
        {label:'Oficial Ayudante',value:'oficial_ayudante'},
        {label:'Sargento',value:'sargento'},
        {label:'Cabo',value:'cabo'},
        {label:'Polic√≠a',value:'policia'}
      ],
      estatus_personales: [{label:'Activo',value:'activo'},{label:'Suspendido',value:'suspendido'},{label:'Baja',value:'baja'}],
      tipos_expediente: [{label:'Disciplinario',value:'disciplinario'},{label:'Administrativo',value:'administrativo'},{label:'Penal',value:'penal'}],
      icap_oficinas: [{label:'Caracas',value:'caracas'},{label:'Maracay',value:'maracay'},{label:'Valencia',value:'valencia'}],
      func_investigados: [{label:'Capit√°n Juan P√©rez',value:'cap_juan'},{label:'Teniente Mar√≠a L√≥pez',value:'ten_maria'},{label:'Sargento Carlos Rojas',value:'sarg_carlos'}],
      condiciones_func: [{label:'Imputado',value:'imputado'},{label:'Testigo',value:'testigo'},{label:'Denunciado',value:'denunciado'}],
      denunciantes: [{label:'Ciudadano An√≥nimo',value:'ciudadano'},{label:'Oficial Superior',value:'superior'},{label:'Otro Funcionario',value:'otro_func'},{label:'Instituci√≥n P√∫blica',value:'institucion'}],
      origenes_falta: [{label:'Interna',value:'interna'},{label:'Externa',value:'externa'}],
      tipos_falta: [{label:'Leve',value:'leve'},{label:'Grave',value:'grave'},{label:'Muy Grave',value:'muy_grave'}],
      faltas_art: [
        {label:'Art. 45 ‚Äì Abandono de cargo',value:'art45'},
        {label:'Art. 46 ‚Äì Insubordinaci√≥n',value:'art46'},
        {label:'Art. 47 ‚Äì Uso indebido de uniforme',value:'art47'},
        {label:'Art. 48 ‚Äì Conducta inmoral',value:'art48'}
      ],
      estatus_expedientes: [{label:'Abierto',value:'abierto'},{label:'Cerrado',value:'cerrado'},{label:'Archivado',value:'archivado'}],
      decisiones: [
        {label:'Sanci√≥n Administrativa',value:'sancion'},
        {label:'Absoluci√≥n',value:'absolucion'},
        {label:'Remisi√≥n a Fiscal√≠a',value:'remision'},
        {label:'Archivo del caso',value:'archivo'}
      ],
      func_detenidos: [{label:'S√≠',value:'si'},{label:'No',value:'no'}]
    };

    // localStorage
    function loadLists() {
      const saved = localStorage.getItem('dropdownLists');
      return saved ? JSON.parse(saved) : defaultLists;
    }
    function saveLists(lists) {
      localStorage.setItem('dropdownLists', JSON.stringify(lists));
    }

    // Rellenar select
    function populateSelect(selectId, options) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">Seleccionar</option>';
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        select.appendChild(option);
      });
    }

    // Renderizar lista en modal
    function renderList(listKey, containerId) {
      const lists = loadLists();
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      lists[listKey].forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'option-item';
        div.innerHTML = `${item.label} <button onclick="removeOption('${listKey}', ${index})" style="background:none;border:none;color:#c00;cursor:pointer;font-size:18px;">üóëÔ∏è</button>`;
        container.appendChild(div);
      });
    }

    // Agregar opci√≥n
    function addOption(listKey, inputId, containerId) {
      const input = document.getElementById(inputId);
      const label = input.value.trim();
      if (!label) return;
      const value = label.toLowerCase().replace(/\s+/g, '_').replace(/[^\w]/g, '');
      const lists = loadLists();
      lists[listKey].push({ label, value });
      saveLists(lists);
      input.value = '';
      renderList(listKey, containerId);
      populateSelectFromList(listKey);
    }

    // Eliminar opci√≥n
    function removeOption(listKey, index) {
      const lists = loadLists();
      lists[listKey].splice(index, 1);
      saveLists(lists);
      renderList(listKey, getContainerId(listKey));
      populateSelectFromList(listKey);
    }

    // Mapeo contenedores
    function getContainerId(listKey) {
      const map = {
        sexos: 'sexoList',
        jerarquias: 'jerarquiaList',
        estatus_personales: 'estatusPersonalList',
        tipos_expediente: 'tipoExpedienteList',
        icap_oficinas: 'icapOficinaList',
        func_investigados: 'funcInvestigadoList',
        condiciones_func: 'condicionFuncList',
        denunciantes: 'denuncianteList',
        origenes_falta: 'origenFaltaList',
        tipos_falta: 'tipoFaltaList',
        faltas_art: 'faltaArtList',
        estatus_expedientes: 'estatusExpedienteList',
        decisiones: 'decisionList',
        func_detenidos: 'funcDetenidoList'
      };
      return map[listKey];
    }

    // Rellenar selects
    function populateSelectFromList(listKey) {
      const lists = loadLists();
      const map = {
        sexos: 'sexo',
        jerarquias: 'jerarquia',
        estatus_personales: 'estatusPersonal',
        tipos_expediente: 'tipoExpediente',
        icap_oficinas: 'icapOficina',
        func_investigados: 'funcInvestigado',
        condiciones_func: 'condicionFunc',
        denunciantes: 'denunciante',
        origenes_falta: 'origenFalta',
        tipos_falta: 'tipoFalta',
        faltas_art: 'faltaArt',
        estatus_expedientes: 'estatusExpediente',
        decisiones: 'decision',
        func_detenidos: 'funcDetenido'
      };
      const selectId = map[listKey];
      if (selectId && lists[listKey]) {
        populateSelect(selectId, lists[listKey]);
      }
    }

    // Inicializar
    function init() {
      const lists = loadLists();
      Object.keys(lists).forEach(key => {
        populateSelectFromList(key);
      });
    }

    // Modal
    function openConfigModal() {
      document.getElementById('configModal').style.display = 'block';
      Object.keys(defaultLists).forEach(key => {
        renderList(key, getContainerId(key));
      });
    }
    function closeConfigModal() {
      document.getElementById('configModal').style.display = 'none';
    }

    // Vista previa foto
    document.getElementById('fotoInput').addEventListener('change', function(e) {
      const preview = document.getElementById('photoPreview');
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          preview.innerHTML = `<img src="${event.target.result}" alt="Foto">`;
        };
        reader.readAsDataURL(file);
      } else {
        preview.innerHTML = '<span class="photo-placeholder">üì∑</span>';
      }
    });

    // Guardar
    document.querySelector('.btn-save').addEventListener('click', async () => {
      const nombre = document.getElementById('nombre').value.trim();
      const apellido = document.getElementById('apellido').value.trim();
      const cedula = document.getElementById('cedula').value.trim();
      if (!nombre || !apellido || !cedula) {
        alert('‚ö†Ô∏è Nombre, Apellido y C√©dula son obligatorios.');
        return;
      }

      const fotoFile = document.getElementById('fotoInput').files[0];
      let fotoUrl = null;

      try {
        if (fotoFile) {
          const fileExt = fotoFile.name.split('.').pop();
          const fileName = `expedientes/${cedula}-${Date.now()}.${fileExt}`;
          const { error: uploadError } = await supabase.storage
            .from('fotos-expedientes')
            .upload(fileName, fotoFile, { upsert: true });
          if (uploadError) throw uploadError;
          const { data } = supabase.storage
            .from('fotos-expedientes')
            .getPublicUrl(fileName);
          fotoUrl = data.publicUrl;
        }

        const { error: insertError } = await supabase
          .from('expedientes')
          .insert([{
            nombre,
            apellido,
            cedula,
            fecha_nacimiento: document.getElementById('fechaNac').value || null,
            sexo: document.getElementById('sexo').value || null,
            edad: parseInt(document.getElementById('edad').value) || null,
            jerarquia: document.getElementById('jerarquia').value || null,
            estatus_personal: document.getElementById('estatusPersonal').value || null,
            telefono: document.getElementById('telefono').value || null,
            correo: document.getElementById('correo').value || null,
            direccion: document.getElementById('direccion').value || null,
            foto_url: fotoUrl,
            tipo_expediente: document.getElementById('tipoExpediente').value || null,
            icap_oficina: document.getElementById('icapOficina').value || null,
            func_investigado: document.getElementById('funcInvestigado').value || null,
            condicion_func: document.getElementById('condicionFunc').value || null,
            denunciante: document.getElementById('denunciante').value || null,
            origen_falta: document.getElementById('origenFalta').value || null,
            tipo_falta: document.getElementById('tipoFalta').value || null,
            falta_art: document.getElementById('faltaArt').value || null,
            estatus_expediente: document.getElementById('estatusExpediente').value || null,
            decision: document.getElementById('decision').value || null,
            resena: document.getElementById('resena').value || null,
            servicio_labora: document.getElementById('servicioLabora').value || null,
            expediente_penal_anio: parseInt(document.getElementById('expedientePenalAnio').value) || null,
            fecha_inicio: document.getElementById('fechaInicio').value || null,
            expediente_numero: document.getElementById('expedienteNumero').value || null,
            causa: document.getElementById('causa').value || null,
            func_detenido: document.getElementById('funcDetenido').value === 'si',
            sustanciador: document.getElementById('sustanciador').value || null,
            registrado_por: document.getElementById('registradoPor').value || null
          }]);

        if (insertError) throw insertError;
        alert('‚úÖ Expediente guardado correctamente.');
        window.location.href = 'index.html';

      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al guardar: ' + (error.message || 'Intente nuevamente.'));
      }
    });

    // Iniciar
    init();
  </script>
</body>
</html>
