<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editar Expediente - ICAP Nacional</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background-color: #fafafa;
      font-family: 'Inter', sans-serif;
      color: #2d2d2d;
      padding: 20px;
      line-height: 1.5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      padding: 32px;
    }
    .logo {
      width: 80px;
      display: block;
      margin: 0 auto 20px;
    }
    h1 {
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      color: #2d2d2d;
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #722F37;
      margin: 28px 0 16px;
      padding-bottom: 6px;
      border-bottom: 2px solid #f0f0f0;
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      margin-bottom: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #333;
    }
    input, select, textarea {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 15px;
      background-color: #fdfdfd;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #722F37;
      box-shadow: 0 0 0 3px rgba(114, 47, 55, 0.1);
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    .photo-upload-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 24px;
    }
    .photo-preview-box {
      width: 120px;
      height: 120px;
      border: 2px dashed #ccc;
      border-radius: 10px;
      background-color: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      overflow: hidden;
    }
    .photo-preview-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .photo-placeholder {
      color: #999;
      font-size: 28px;
    }
    .photo-input {
      width: 100%;
      max-width: 220px;
      padding: 8px;
      font-size: 14px;
      text-align: center;
    }
    .btn-save {
      background-color: #722F37;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s ease;
      display: block;
      width: 100%;
      max-width: 220px;
    }
    .btn-save:hover {
      background-color: #5e262d;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(114, 47, 55, 0.2);
    }
    .back-link {
      display: inline-block;
      margin-top: 10px;
      color: #722F37;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #722F37;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <img 
      src="https://raw.githubusercontent.com/icapnacional/sistema-expedientes/main/Logo.png" 
      alt="ICAP Nacional - PNB" 
      class="logo"
    />
    <h1>Editar Expediente</h1>
    <div id="loading" class="loading">Cargando expediente...</div>
    <div id="formContainer" style="display: none;">
      <div class="photo-upload-container">
        <div class="photo-preview-box" id="photoPreview">
          <span class="photo-placeholder">📷</span>
        </div>
        <input type="file" id="fotoInput" accept="image/*" class="photo-input">
      </div>
      <!-- Sección: Datos Personales -->
      <h2 class="section-title">Datos Personales</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="nombre">Nombre</label>
          <input type="text" id="nombre" required>
        </div>
        <div class="form-group">
          <label for="apellido">Apellido</label>
          <input type="text" id="apellido" required>
        </div>
        <div class="form-group">
          <label for="fechaNac">Fecha de Nacimiento</label>
          <input type="date" id="fechaNac">
        </div>
        <div class="form-group">
          <label for="cedula">Cédula de Identidad</label>
          <input type="text" id="cedula" readonly>
        </div>
        <div class="form-group">
          <label for="sexo">Sexo</label>
          <select id="sexo">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edad">Edad</label>
          <input type="number" id="edad" min="18" max="100">
        </div>
        <div class="form-group">
          <label for="jerarquia">Jerarquía</label>
          <select id="jerarquia">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="estatusPersonal">Estatus</label>
          <select id="estatusPersonal">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="telefono">Teléfono</label>
          <input type="tel" id="telefono">
        </div>
        <div class="form-group">
          <label for="correo">Correo</label>
          <input type="email" id="correo">
        </div>
        <div class="form-group">
          <label for="direccion">Dirección</label>
          <textarea id="direccion"></textarea>
        </div>
      </div>
      <!-- Sección: Expediente -->
      <h2 class="section-title">Expediente</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="tipoExpediente">Tipo de Expediente</label>
          <select id="tipoExpediente">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="icapOficina">ICAP (Oficina)</label>
          <select id="icapOficina">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="funcInvestigado">Funcionario Investigado</label>
          <select id="funcInvestigado">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="condicionFunc">Condición del Funcionario en el Caso</label>
          <select id="condicionFunc">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="denunciante">Denunciante</label>
          <select id="denunciante">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="origenFalta">Origen de la Falta</label>
          <select id="origenFalta">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="tipoFalta">Tipo de Falta</label>
          <select id="tipoFalta">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="faltaArt">Falta (Artículo)</label>
          <select id="faltaArt">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="estatusExpediente">Estatus</label>
          <select id="estatusExpediente">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="decision">Decisión</label>
          <select id="decision">
            <option value="">Cargando...</option>
          </select>
        </div>
      </div>
      <!-- Campos de texto libre -->
      <div class="form-group">
        <label for="resena">Reseña del Caso</label>
        <textarea id="resena"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="servicioLabora">Servicio donde Labora</label>
          <input type="text" id="servicioLabora">
        </div>
        <div class="form-group">
          <label for="expedientePenalAnio">Expediente Penal Año</label>
          <input type="number" id="expedientePenalAnio" min="1900" max="2099">
        </div>
        <div class="form-group">
          <label for="fechaInicio">Fecha de Inicio</label>
          <input type="date" id="fechaInicio">
        </div>
        <div class="form-group">
          <label for="expedienteNumero">Expediente Número</label>
          <input type="text" id="expedienteNumero">
        </div>
        <div class="form-group">
          <label for="causa">Causa</label>
          <input type="text" id="causa">
        </div>
        <div class="form-group">
          <label for="funcDetenido">¿Funcionario Detenido?</label>
          <select id="funcDetenido">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="sustanciador">Sustanciador Remisión</label>
          <input type="text" id="sustanciador">
        </div>
        <div class="form-group">
          <label for="registradoPor">Registrado Por</label>
          <input type="text" id="registradoPor">
        </div>
      </div>
      <button class="btn-save" id="btnSave">Guardar Cambios</button>
    </div>
    <a href="index.html" class="back-link">← Volver al Panel</a>
  </div>
  <script>
    const SUPABASE_URL = 'https://stwriaubepeugobgyxjt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0d3JpYXViZXBldWdvYmd5eGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NDU0MDUsImV4cCI6MjA3MDMyMTQwNX0.3Rorn10j19M2nmmv03oSEwm-O-y0bsywAA8_CRR2O1g';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        alert('Acceso restringido. Por favor inicie sesión.');
        window.location.href = 'index.html';
        return;
      }
    })();
    const defaultLists = {
      sexos: [{label:'Masculino',value:'masculino'},{label:'Femenino',value:'femenino'},{label:'Otro',value:'otro'}],
      jerarquias: [
        {label:'Comisario General',value:'comisario_general'},
        {label:'Comisario Jefe',value:'comisario_jefe'},
        {label:'Comisario',value:'comisario'},
        {label:'Subcomisario',value:'subcomisario'},
        {label:'Inspector Jefe',value:'inspector_jefe'},
        {label:'Inspector',value:'inspector'},
        {label:'Subinspector',value:'subinspector'},
        {label:'Oficial Jefe',value:'oficial_jefe'},
        {label:'Oficial',value:'oficial'},
        {label:'Oficial Ayudante',value:'oficial_ayudante'},
        {label:'Sargento',value:'sargento'},
        {label:'Cabo',value:'cabo'},
        {label:'Policía',value:'policia'}
      ],
      estatus_personales: [{label:'Activo',value:'activo'},{label:'Suspendido',value:'suspendido'},{label:'Baja',value:'baja'}],
      tipos_expediente: [{label:'Disciplinario',value:'disciplinario'},{label:'Administrativo',value:'administrativo'},{label:'Penal',value:'penal'}],
      icap_oficinas: [{label:'Caracas',value:'caracas'},{label:'Maracay',value:'maracay'},{label:'Valencia',value:'valencia'}],
      func_investigados: [{label:'Capitán Juan Pérez',value:'cap_juan'},{label:'Teniente María López',value:'ten_maria'},{label:'Sargento Carlos Rojas',value:'sarg_carlos'}],
      condiciones_func: [{label:'Imputado',value:'imputado'},{label:'Testigo',value:'testigo'},{label:'Denunciado',value:'denunciado'}],
      denunciantes: [{label:'Ciudadano Anónimo',value:'ciudadano'},{label:'Oficial Superior',value:'superior'},{label:'Otro Funcionario',value:'otro_func'},{label:'Institución Pública',value:'institucion'}],
      origenes_falta: [{label:'Interna',value:'interna'},{label:'Externa',value:'externa'}],
      tipos_falta: [{label:'Leve',value:'leve'},{label:'Grave',value:'grave'},{label:'Muy Grave',value:'muy_grave'}],
      faltas_art: [
        {label:'Art. 45 – Abandono de cargo',value:'art45'},
        {label:'Art. 46 – Insubordinación',value:'art46'},
        {label:'Art. 47 – Uso indebido de uniforme',value:'art47'},
        {label:'Art. 48 – Conducta inmoral',value:'art48'}
      ],
      estatus_expedientes: [{label:'Abierto',value:'abierto'},{label:'Cerrado',value:'cerrado'},{label:'Archivado',value:'archivado'}],
      decisiones: [
        {label:'Sanción Administrativa',value:'sancion'},
        {label:'Absolución',value:'absolucion'},
        {label:'Remisión a Fiscalía',value:'remision'},
        {label:'Archivo del caso',value:'archivo'}
      ],
      func_detenidos: [{label:'Sí',value:'si'},{label:'No',value:'no'}]
    };
    function loadLists() {
      const saved = localStorage.getItem('dropdownLists');
      return saved ? JSON.parse(saved) : defaultLists;
    }
    function populateSelect(selectId, options) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">Seleccionar</option>';
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        select.appendChild(option);
      });
    }
    function populateSelectFromList(listKey) {
      const lists = loadLists();
      const map = {
        sexos: 'sexo',
        jerarquias: 'jerarquia',
        estatus_personales: 'estatusPersonal',
        tipos_expediente: 'tipoExpediente',
        icap_oficinas: 'icapOficina',
        func_investigados: 'funcInvestigado',
        condiciones_func: 'condicionFunc',
        denunciantes: 'denunciante',
        origenes_falta: 'origenFalta',
        tipos_falta: 'tipoFalta',
        faltas_art: 'faltaArt',
        estatus_expedientes: 'estatusExpediente',
        decisiones: 'decision',
        func_detenidos: 'funcDetenido'
      };
      const selectId = map[listKey];
      if (selectId && lists[listKey]) {
        populateSelect(selectId, lists[listKey]);
      }
    }
    function initDropdowns() {
      const lists = loadLists();
      Object.keys(lists).forEach(key => {
        populateSelectFromList(key);
      });
    }
    let currentPhotoUrl = null;
    document.getElementById('fotoInput').addEventListener('change', function(e) {
      const preview = document.getElementById('photoPreview');
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          preview.innerHTML = `<img src="${event.target.result}" alt="Foto">`;
        };
        reader.readAsDataURL(file);
      } else if (currentPhotoUrl) {
        preview.innerHTML = `<img src="${currentPhotoUrl}" alt="Foto">`;
      } else {
        preview.innerHTML = '<span class="photo-placeholder">📷</span>';
      }
    });
    function getIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }
    async function loadExpediente(id) {
      console.log("Cargando expediente con ID:", id); // ✅ LOG
      const { data, error } = await supabase
        .from('expedientes')
        .select('*')
        .eq('id', id)
        .single();
      if (error || !data) {
        console.error("Error al cargar:", error);
        alert('No se encontró el expediente.');
        return null;
      }
      console.log("Expediente cargado:", data); // ✅ LOG
      return data;
    }
    function fillForm(expediente) {
      document.getElementById('nombre').value = expediente.nombre || '';
      document.getElementById('apellido').value = expediente.apellido || '';
      document.getElementById('cedula').value = expediente.cedula || '';
      document.getElementById('fechaNac').value = expediente.fecha_nacimiento || '';
      document.getElementById('sexo').value = expediente.sexo || '';
      document.getElementById('edad').value = expediente.edad || '';
      document.getElementById('jerarquia').value = expediente.jerarquia || '';
      document.getElementById('estatusPersonal').value = expediente.estatus_personal || '';
      document.getElementById('telefono').value = expediente.telefono || '';
      document.getElementById('correo').value = expediente.correo || '';
      document.getElementById('direccion').value = expediente.direccion || '';
      document.getElementById('tipoExpediente').value = expediente.tipo_expediente || '';
      document.getElementById('icapOficina').value = expediente.icap_oficina || '';
      document.getElementById('funcInvestigado').value = expediente.func_investigado || '';
      document.getElementById('condicionFunc').value = expediente.condicion_func || '';
      document.getElementById('denunciante').value = expediente.denunciante || '';
      document.getElementById('origenFalta').value = expediente.origen_falta || '';
      document.getElementById('tipoFalta').value = expediente.tipo_falta || '';
      document.getElementById('faltaArt').value = expediente.falta_art || '';
      document.getElementById('estatusExpediente').value = expediente.estatus_expediente || '';
      document.getElementById('decision').value = expediente.decision || '';
      document.getElementById('resena').value = expediente.resena || '';
      document.getElementById('servicioLabora').value = expediente.servicio_labora || '';
      document.getElementById('expedientePenalAnio').value = expediente.expediente_penal_anio || '';
      document.getElementById('fechaInicio').value = expediente.fecha_inicio || '';
      document.getElementById('expedienteNumero').value = expediente.expediente_numero || '';
      document.getElementById('causa').value = expediente.causa || '';
      document.getElementById('funcDetenido').value = expediente.func_detenido ? 'si' : 'no';
      document.getElementById('sustanciador').value = expediente.sustanciador || '';
      document.getElementById('registradoPor').value = expediente.registrado_por || '';
      currentPhotoUrl = expediente.foto_url;
      const preview = document.getElementById('photoPreview');
      if (currentPhotoUrl) {
        preview.innerHTML = `<img src="${currentPhotoUrl}" alt="Foto">`;
      } else {
        preview.innerHTML = '<span class="photo-placeholder">📷</span>';
      }
    }
    document.getElementById('btnSave').addEventListener('click', async () => {
      const cedula = document.getElementById('cedula').value.trim();
      const nombre = document.getElementById('nombre').value.trim();
      const apellido = document.getElementById('apellido').value.trim();
      if (!nombre || !apellido || !cedula) {
        alert('⚠️ Nombre, Apellido y Cédula son obligatorios.');
        return;
      }
      const fotoFile = document.getElementById('fotoInput').files[0];
      let fotoUrl = currentPhotoUrl;
      try {
        if (fotoFile) {
          const fileExt = fotoFile.name.split('.').pop();
          const fileName = `expedientes/${cedula}-${Date.now()}.${fileExt}`;
          const { error: uploadError } = await supabase.storage
            .from('fotos-expedientes')
            .upload(fileName, fotoFile, { upsert: true });
          if (uploadError) throw uploadError;
          const { data } = await supabase.storage
            .from('fotos-expedientes')
            .getPublicUrl(fileName);
          fotoUrl = data.publicUrl;
        }
        const id = getIdFromUrl();
        if (!id) {
          alert('No se encontró el ID del expediente.');
          return;
        }
        console.log("Actualizando ID:", id); // ✅ LOG
        const { error: updateError } = await supabase
          .from('expedientes')
          .update({
            nombre,
            apellido,
            fecha_nacimiento: document.getElementById('fechaNac').value || null,
            sexo: document.getElementById('sexo').value || null,
            edad: parseInt(document.getElementById('edad').value) || null,
            jerarquia: document.getElementById('jerarquia').value || null,
            estatus_personal: document.getElementById('estatusPersonal').value || null,
            telefono: document.getElementById('telefono').value || null,
            correo: document.getElementById('correo').value || null,
            direccion: document.getElementById('direccion').value || null,
            foto_url: fotoUrl,
            tipo_expediente: document.getElementById('tipoExpediente').value || null,
            icap_oficina: document.getElementById('icapOficina').value || null,
            func_investigado: document.getElementById('funcInvestigado').value || null,
            condicion_func: document.getElementById('condicionFunc').value || null,
            denunciante: document.getElementById('denunciante').value || null,
            origen_falta: document.getElementById('origenFalta').value || null,
            tipo_falta: document.getElementById('tipoFalta').value || null,
            falta_art: document.getElementById('faltaArt').value || null,
            estatus_expediente: document.getElementById('estatusExpediente').value || null,
            decision: document.getElementById('decision').value || null,
            resena: document.getElementById('resena').value || null,
            servicio_labora: document.getElementById('servicioLabora').value || null,
            expediente_penal_anio: parseInt(document.getElementById('expedientePenalAnio').value) || null,
            fecha_inicio: document.getElementById('fechaInicio').value || null,
            expediente_numero: document.getElementById('expedienteNumero').value || null,
            causa: document.getElementById('causa').value || null,
            func_detenido: document.getElementById('funcDetenido').value === 'si',
            sustanciador: document.getElementById('sustanciador').value || null,
            registrado_por: document.getElementById('registradoPor').value || null
          })
          .eq('id', id);
        if (updateError) {
          console.error("Error al actualizar:", updateError);
          throw updateError;
        }
        console.log("✅ Actualización exitosa"); // ✅ LOG
        alert('✅ Expediente actualizado correctamente.');
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Error al actualizar:', error);
        alert('❌ Error al guardar cambios: ' + (error.message || 'Intente nuevamente.'));
      }
    });
    (async () => {
      const id = getIdFromUrl();
      if (!id) {
        alert('No se especificó el ID del expediente.');
        window.location.href = 'index.html';
        return;
      }
      initDropdowns();
      const expediente = await loadExpediente(id);
      if (expediente) {
        fillForm(expediente);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('formContainer').style.display = 'block';
      }
    })();
  </script>
</body>
</html>
